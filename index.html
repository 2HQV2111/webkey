<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>T·∫°o Key m·ªõi</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRlIh-vPXOhDjK13KWtmWqYAswksBNuvOOUzA&s') no-repeat center center fixed;
      background-size: cover;
      background-color: rgba(0, 0, 0, 0.4);
      color: white;
      text-shadow: 1px 1px 2px black;
    }
    input, button, select {
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      border: none;
      border-radius: 5px;
    }
    input, select {
      background: rgba(255,255,255,0.85);
      color: #000;
    }
    button {
      background: linear-gradient(135deg, #ff4e50, #f9d423);
      color: #fff;
      font-weight: bold;
      font-size: 16px;
      text-transform: uppercase;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      transition: 0.3s ease;
    }
    button:hover {
      background: linear-gradient(135deg, #f9d423, #ff4e50);
      transform: scale(1.08);
    }
    .log {
      margin-top: 20px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ƒêƒÉng nh·∫≠p -->
  <div id="loginSection">
    <h2>üîê ƒêƒÉng nh·∫≠p</h2>
    <label>T√™n ƒëƒÉng nh·∫≠p:</label>
    <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
    <label>M·∫≠t kh·∫©u:</label>
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
    <div id="loginLog" class="log"></div>
  </div>

  <!-- Form t·∫°o key -->
  <div id="keySection" class="hidden">
    <h2>T·∫°o Key m·ªõi</h2>
    <label>Nh·∫≠p t√™n mi·ªÅn:</label>
    <input type="text" id="prefix" placeholder="Nh·∫≠p t√™n mi·ªÅn">
    <label>S·ªë l∆∞·ª£ng key mu·ªën t·∫°o:</label>
    <input type="number" id="keyCount" value="1" min="1">
    <label>Th·ªùi h·∫°n:</label>
    <div style="display: flex; gap: 10px;">
      <input type="number" id="days" placeholder="Ng√†y" style="flex: 1;">
      <input type="number" id="hours" placeholder="Gi·ªù" style="flex: 1;">
      <input type="number" id="minutes" placeholder="Ph√∫t" style="flex: 1;">
      <input type="number" id="seconds" placeholder="Gi√¢y" style="flex: 1;">
    </div>
    <label>S·ªë thi·∫øt b·ªã cho ph√©p:</label>
    <input type="number" id="maxDevices" value="1">
    <button onclick="createKeys()">üöÄ T·∫°o Key Ngay</button>
    <div class="log" id="log"></div>
  </div>

  <script src="users.js"></script>
  <script>
    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      const loginLog = document.getElementById("loginLog");

      const validUser = USERS.find(u => u.username === user && u.password === pass);

      if (validUser) {
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("keySection").classList.remove("hidden");
      } else {
        loginLog.innerText = "‚ùå Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!";
      }
    }

    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    async function createKeys() {
      const prefix = document.getElementById('prefix').value.trim();
      const keyCount = parseInt(document.getElementById('keyCount').value);
      const maxDevices = parseInt(document.getElementById('maxDevices').value);
      const log = document.getElementById('log');

      const days = parseInt(document.getElementById('days').value) || 0;
      const hours = parseInt(document.getElementById('hours').value) || 0;
      const minutes = parseInt(document.getElementById('minutes').value) || 0;
      const seconds = parseInt(document.getElementById('seconds').value) || 0;

      const totalSeconds = (days * 86400) + (hours * 3600) + (minutes * 60) + seconds;

      if (!prefix) {
        log.innerText = '‚ö†Ô∏è B·∫°n ch∆∞a nh·∫≠p t√™n mi·ªÅn.';
        return;
      }
      if (totalSeconds <= 0) {
        log.innerText = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p th·ªùi gian h·ª£p l·ªá.';
        return;
      }

      let resultLog = '';

      for (let i = 0; i < keyCount; i++) {
        let fullKey = '';
        let attempts = 0;
        const maxAttempts = 10;

        while (attempts < maxAttempts) {
          const randomSuffix = generateRandomString(6);
          fullKey = `${prefix}_${randomSuffix}`;

          const checkRes = await fetch(`https://hqvkey-default-rtdb.firebaseio.com/valid_keys/${fullKey}.json`);
          const existing = await checkRes.json();
          if (existing === null) break;
          attempts++;
        }

        if (attempts === maxAttempts) {
          resultLog += `‚ùå Kh√¥ng th·ªÉ t·∫°o key kh√¥ng tr√πng sau ${maxAttempts} l·∫ßn: ${prefix}_xxxxxx\n`;
          continue;
        }

        const url = `https://hqvkey-default-rtdb.firebaseio.com/valid_keys/${fullKey}.json`;
        const body = {
          expires_after: totalSeconds,
          activated_at: 0,
          device_id: "",
          max_devices: maxDevices
        };

        try {
          const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (res.ok) {
            resultLog += `‚úÖ T·∫°o th√†nh c√¥ng: ${fullKey}\n`;
          } else {
            resultLog += `‚ùå L·ªói t·∫°o key ${fullKey}. M√£: ${res.status}\n`;
          }
        } catch (err) {
          resultLog += `‚ùå L·ªói m·∫°ng v·ªõi key ${fullKey}: ${err.message}\n`;
        }
      }

      log.innerText = resultLog;
    }
  </script>
</body>
</html>
